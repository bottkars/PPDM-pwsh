## This Restores Files from CLI using FLR recoveries

### Connect to PPDM API in AVS:
```Powershell
$connection=connect-PPDMapiEndpoint -trustCert -PPDM_API_BaseURI ppdmavs01.edub.csc
$RestoreFromHost = "WhqNQLqCLJ2yw.edub.csc"
$RestoreToHost_Name = "bM10k2Mjn53aO.edub.csc"
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/26cf7031-3ffe-496d-9df2-3464d524db6c)

### Get all linux Hosts with FLR Agent
We do this with Specifying a Filter
```Powershell
$linuxfilter = 'attributes.appHost.appServerTypes eq "FS" and not (lastDiscoveryStatus eq "DELETED") and details.appHost.os lk "linux" and details.appHost.phase eq "NONE"'
Get-PPDMhosts -filter $linuxfilter | ft
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/d6736d0b-2dde-4d55-a282-264866d72dae)
### Read our Restore Host
```Powershell
$RestoreHostFilter = 'attributes.appHost.appServerTypes eq "FS" and not (lastDiscoveryStatus eq "DELETED") and details.appHost.os lk "linux" and details.appHost.phase eq "NONE"and hostname eq "' + $RestoreToHost_Name + '"'
$RestoreToHost = Get-PPDMhosts -filter $RestoreHostFilter
$RestoreToHost
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/638fc522-e67b-49b2-aa79-74363f8825e3)
### Read the Asset to restore to identify the Asset Copies
```Powershell
$RestoreAssetFilter = 'type eq "FILE_SYSTEM" and protectionStatus eq "PROTECTED" and details.fileSystem.hostName eq  "' + $RestoreFromHost + '"'
$RestoreAssets = Get-PPDMAssets -Filter $RestoreAssetFilter
$RestoreAssets
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/82d55212-4ea5-4108-af74-0e411538c8a3)

### Selecting and mounting the Asset Copy to Restore 
```Powershell
write-host "Selecting Asset-copy for $RestoreFromHost"
$RestoreAssetCopy = $RestoreAssets | Get-PPDMassetcopies -filter 'state eq "IDLE"' | Select-Object -First 1
$RestoredCopy = New-PPDMRestored_copies -ids $RestoreAssetCopy.id -assetName $RestoreAssetCopy.assetName -Hostid $RestoreToHost.id

do {
  Start-Sleep -Seconds 10    
  $MountedCopy = $RestoredCopy | Get-PPDMRestored_copies
}
until ($MountedCopy.status -eq "SUCCESS") 
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/c5e99643-4773-4e2b-8aac-7dfaf72c2e21)

# Optionally, do a Browsing
```Powershell
$Parameters = @{
  HostID               = $RestoreToHost.id
  BackupTransactionID  = $RestoreAssetCopy.backupTransactionId
  Hostpath             = "/home/bottk"
  mountURL             = $MountedCopy.restoredCopiesDetails.targetFileSystemInfo.mountUrl
  RestoreAssetHostname = $RestoreFromHost
}
$Browselist = Get-PPDMFSAgentFLRBrowselist @Parameters
$Browselist.files
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/37cb8ba0-3fd6-4f69-b98d-b6e4a7a5c4db)
## Run the Restore
```Powershell
$Parameters = @{
  HostID               = $RestoreToHost.id 
  BackupTransactionID  = $RestoreAssetCopy.backupTransactionId
  ids                  = $RestoreAssetCopy.id
  RestoreAssetHostname = $RestoreFromHost
  assetName            = $RestoreAssetCopy.assetName
  RestoreLocation      = "/tmp"
  RetainFolderHierachy = $true
  conflictStrategy     = "TO_ALTERNATE" 
  RestoreSources       = "/home/bottk, /root"
  CustomDescription    = "Restore from Powershell"
  Verbose              = $false
}

$Restore = Restore-PPDMFileFLR_copies @Parameters
```
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/f28e3700-35ed-443c-b3ee-829b3bb6d507)
![image](https://github.com/bottkars/PPDM-pwsh/assets/8255007/4d64a255-6e16-4559-9d96-2b16c0899d02)

### Alternative Commands
```Powershell
Restore-PPDMFileFLR_copies -HostID  $RestoreToHost.id -BackupTransactionID $RestoreAssetCopy.backupTransactionId -ids $RestoreAssetCopy.id -RestoreAssetHostname $RestoreFromHost -assetName $RestoreAssetCopy.assetName -RestoreLocation /tmp -RetainFolderHierachy -conflictStrategy TO_ALTERNATE -RestoreSources /home/bottk -

Restore-PPDMFileFLR_copies -HostID  $RestoreToHost.id -BackupTransactionID $RestoreAssetCopy.backupTransactionId -ids $RestoreAssetCopy.id -RestoreAssetHostname $RestoreFromHost -assetName $RestoreAssetCopy.assetName -RestoreLocation /tmp -RetainFolderHierachy -conflictStrategy TO_ALTERNATE -RestoreSources /home/bottk,/root -CustomDescription "Restore from Powershell"
```